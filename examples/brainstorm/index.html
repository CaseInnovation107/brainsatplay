<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta property="og:title" content="Brainstorm" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://brainsatplay.com/sdk/examples/brainstorm.png" />
    <meta property="og:description" content="Brainstorm - A Multiplayer Neurotechnology Game for the Web" />
    <meta property="og:url" content="https://brainsatplay.com/sdk/examples/brainstorm" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@brainsatplay">
    <meta name="twitter:creator" content="@brainsatplay">
    <meta name="twitter:domain" content="brainsatplay.com">
    <meta name="twitter:title" content="Brainstorm">
    <meta name="twitter:url" content="https://brainsatplay.com/sdk/examples/brainstorm">
    <meta name="twitter:description" content="Brainstorm - A Multiplayer Neurotechnology Game for the Web">
    <meta name="twitter:image:src" content="https://brainsatplay.com/sdk/examples/brainstorm.png">
    <title>Brainstorm</title>
    
    <link rel=icon href=favicons/favicon.ico>
    <link rel="stylesheet" type="text/css" href="css/brainstorm.css"/>
    <script type="text/javascript" src="js/visbrain.js"></script>
    <!-- <script type="text/javascript" src="js/bigbrainpoints.js"></script> -->
    <script type="text/javascript" src="classes/Brain.js"></script>
    <script type="text/javascript" src="classes/nBrains.js"></script>
    <script type="text/javascript" src="js/interaction.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/point-functions.js"></script>
    <script type="text/javascript" src="js/networking.js"></script>
    <script type="text/javascript" src="js/gl-matrix-min.js"></script>
    <script type="text/javascript" src="js/webgl.js"></script>
    <script type="text/javascript" src="js/shaders.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcijs@1.8.0/dist/bci.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
</head>

<body onstyle="overflow: hidden">

<div id=app>
    <!-- <div id="app-menu" class="menu">
        <div id="menu-toggle" class="toggle"><div class="icon"><i class="fas fa-angle-right fa-3x"></i></div></div>
        <div class="icon menuicon" onclick="window.open(`/downloadapp`)">
            <a><i class="fas fa-desktop fa-2x"></i></a><p>Download Desktop App</p>
        </div>
    </div> -->

    <div id="chat">
        <ul id="messages"></ul>
        <form id="chat-form" action="">
            <label for="message"></label>
            <input type="text" id="message" autocomplete="off" placeholder="Say hello..."/>
        </form>
    </div>

    <!-- <div id="developer-tools" class="menu">
        <div class="icon" onclick="state = 2">
            <a><i class="fas fa-brain fa-2x"></i></a><p>View your Brain Activity</p>
        </div>
        <div class="icon" onclick="state = 3">
            <a><i class="fas fa-wave-square fa-2x"></i></a><p>Inspect Raw Voltages</p>
        </div>
        <div class="icon" onclick="state = 4">
            <a><i class="fas fa-users fa-2x"></i></a><p>View Users</p>
        </div>
        <div class="icon" onclick="function(this) {console.log(this); state = 5; console.log(5);his.className = 'icon menuicon selected'}">
            <a><i class="fas fa-users-cog fa-2x"></i></a><p>View Group Synchrony</p>
        </div>
        <div class="icon" onclick="toggleDevTools()"><p>Exit Developer Tools</p></div>
    </div> -->

    <div id="brainstorm">
        <div id="ui-container">
            <canvas id='webgl'></canvas>
        </div>
        <div class="message-container">
            <span id="canvas-message"></span>
        </div>

        <div id='signaltypes'>
            <button onclick="visualizations[state].signaltype = 'voltage'; document.getElementById('signal-type').innerHTML = 'voltage'; stateManager()">Voltage</button>
            <button onclick="visualizations[state].signaltype = 'synchrony'; document.getElementById('signal-type').innerHTML = 'synchrony'; stateManager()">Synchrony</button>
            <button onclick="visualizations[state].signaltype = 'delta'; document.getElementById('signal-type').innerHTML = 'delta'; stateManager()">Delta</button>
            <button onclick="visualizations[state].signaltype = 'theta'; document.getElementById('signal-type').innerHTML = 'theta'; stateManager()">Theta</button>
            <button onclick="visualizations[state].signaltype = 'alpha'; document.getElementById('signal-type').innerHTML = 'alpha'; stateManager()">Alpha</button>
            <button onclick="visualizations[state].signaltype = 'beta'; document.getElementById('signal-type').innerHTML = 'beta'; stateManager()">Beta</button>
            <button onclick="visualizations[state].signaltype = 'gamma'; document.getElementById('signal-type').innerHTML = 'gamma'; stateManager()">Gamma</button>
        </div>

        <div id="bottom-bar">
            <div id="bottom-info">
        <div class="title">
            <h4>Brainstorm</h4>
            <p>Created by <a href="https://brainsatplay.com">Brains@Play</a></p>
        </div>
        <div>
        <div class=icongrid>
            <div class="menuicon" onclick="state = 1">
                <i class="fas fa-brain fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 2">
                <i class="fas fa-wave-square fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 3">
                <i class="fas fa-users fa-1x"></i>
            </div>
            <div class="menuicon" onclick="state = 4;">
                <i class="fas fa-users-cog fa-1x"></i>
            </div>
        </div>
        </div>
        <div class="params">
            <h5>State</h5>
            <p id="state" class="small"></p>
            <h5>ID</h5>
            <p id="userId" class="small">Simulation</p>
        </div>
        <div class="params">
            <h5>Signal</h5>
            <p id="signal-type" class="small"></p>
            <h5>nBrains</h5>
            <p id="nBrains" class="small">not connected</p>
        </div>
        <div class="params">
            <button id="connection-button" onclick="toggleConnection();">Enter the Brainstorm</button>
        </div>
        <div class="params">
            <button id="connection-button" onclick="mouseDistort = !mouseDistort;">Toggle Mouse Distort</button>
        </div>
        <div class="filler">
        </div>
        <!-- <div class=icongrid>
            <div class="menuicon" onclick="toggleChat()">
                <i class="fas fa-comment"></i>
            </div>
            <div class="menuicon" onclick="toggleDevTools()">
                <i class="fas fa-desktop fa-1x"></i>
            </div>
        </div> -->
        </div>
    </div>
    </div>
    </div>
</div>

<script>

    // Set Deployment Controls
    let option = 'local';

    // Initialize WebGL Canvas
    let canvas = document.getElementById('webgl');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let gl = canvas.getContext('webgl')

    // Set Visualization Controls
    let GENERIC_ZOOM = max([1e5/window.innerWidth,1e5/window.innerHeight])*2
    let effects = [false, 'projection','synchrony','scan'] // Order used in Shaders.js code

    let visualizations = [{
        name: 'Scan Phase', 
        shapes: ['sphereShells'], // shape of points
        render: gl.POINTS,
        type: 'intro',
        timer: 5.0, // display time in seconds; false has no animation
        message: 'scanning...',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'scan',
        signaltype: undefined
    },
    {
        name: '3D Brain', 
        shapes: ['brain'],
        type: 'main',
        render: gl.POINTS,
        timer: false, 
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'projection',
        signaltype: 'voltage'
    },{
        name: 'Data Streams', 
        shapes: ['channels'],
        type: 'main',
        render: gl.LINES,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'z_displacement',
        signaltype: 'voltage'
    },{
        name: 'User Information', 
        shapes: ['brains'],
        type: 'main',
        render: gl.POINTS,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: false,
        signaltype: undefined
    },{
        name: 'You vs. Group', 
        shapes: ['brain'],
        type: 'main',
        render: gl.POINTS,
        timer: false,
        message: '',
        ease: 0.1,
        zoom: GENERIC_ZOOM,
        effect: 'synchrony',
        signaltype: 'synchrony'
    }
]

    let channels = 8;
    let DESIRED_POINTS = 1e5/2; // 80000
    let SIGNAL_SUSTAIN_ORIGINAL = 100;
    let AUTO_ROTATION_X = 0.0;
    let SYNCHRONY_BUFFER_SIZE = 100;
    let DAMPING = .1;
    let epsilon = .001;

    let eegCoords = [
        [-25.0,75.0,-25.0],// [// 1 Fp1
        [25.0,75.0,-25.0], // 2 Fp2
        [-25.0,0.00,75.0], // 3 C3
        [25.0,0.00,75.0], // 4 C4
        [-75.0,-65.0,-10.0], // 5 P7
        [75.0,-65.0,-10.0], // 6 P8
        [-25.0,-125.0,0.00], // 7 O1
        [25.0,-125.0,0.00], // 8 O2
        [-75.0,35.0,-20], // 9 F7
        [75.0,35.0,-20], // 10 F8
        [-25.0,60.0,50.0], // 11
        [25.0,60.0,50.0], // 12
        [-75.0,-15.0,-15.0], // 13 T7
        [75.0,-15.0,-15.0], // 14 T8
        [-25.0,-75.0,60.0], // 15
        [25.0,-75.0,60.0], // 16
    ]
    // eegCoords = eegCoords.map((val) => {return val*100})
    let passedEEGCoords = eegCoords

    // Declare Global Visualization Variables
    let state = 0;
    let prevState = 0;
    let animState = 0;
    let renderState = state;
    let renderLagStart;
    let animStart = Date.now();
    let brainVertices;
    let brainMesh;
    let vertexHome;
    let vertexCurr;
    let vertexVel;
    let viewMatrix;
    let projectionMatrix;

    let originalAspectX;
    let originalAspectY;

    let positionBuffer;
    let dispBuffer;
    let colorBuffer;
    let uniformLocations;
    let SIGNAL_SUSTAIN = Math.round(SIGNAL_SUSTAIN_ORIGINAL/channels);
    if (SIGNAL_SUSTAIN%2 == 0){
            SIGNAL_SUSTAIN += 1;
    }
    let pointCount;
    let color;
    let synchrony = new Array(SYNCHRONY_BUFFER_SIZE).fill(0);
    let cameraHome = visualizations[state].zoom;
    let cameraCurr = visualizations[state].zoom;
    let t = 0.0;
    let diff_x = 0;
    let diff_y = 0;
    let ease = true;
    let rotation = true;
    let zoom = true;
    let generate;
    let base_freq = 1;
    let samplerate = 125;
    let generate_interval = Math.round(samplerate*(1/base_freq))
    let count = 0;
    let distort = false;
    let distortion = 0;
    let distortFlag = false;
    let distortIter = 1;
    let messages = []
    let url;
    if (option  === 'local'){
        url = new URL('http://localhost');
    } else if (option === 'server'){
        url = new URL('https://brainsatplay.azurewebsites.net/');
    }
    let brains;
    let userId = undefined;
    let ws = undefined;
    let welcomed = false;

    // Set User Interactions
    let holdStatus = false;
    let mouseEv;
    let moveStatus;
    let x;
    let y;
    let prev_x;
    let prev_y;
    let scroll;
    let diff;
    let diff_total;
    let forceSink;
    let messageStartTime = undefined;

    // Set User Interactions
    let devTools = false;
    let chat = false;
    let mouseDistort = false;

    canvas.onmousedown = mouseDown;
    canvas.onmouseup = mouseUp
    canvas.onmousemove = mouseMove
    canvas.onwheel = wheelMove
    document.onkeydown = keyboardShortcuts
    bindChatSubmissionEvent()

    // Reduce Point Count
    brainVertices = reducePointCount(brainpoints, DESIRED_POINTS);
    pointCount = brainVertices.length / 3;

    // // Instantiate a Default Set of Brain
    brains = newBrains('me');
    brains.addBrain('other');

    generate = true;
    sendSignal(channels)

    // Begin Rendering the Visualization
    particleCloud()

</script>

</body>
</html>
