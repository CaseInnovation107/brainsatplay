<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width,initial-scale=1">
    <link rel=icon href=favicons/favicon.ico>
    <link rel="stylesheet" type="text/css" href="css/brainstorm.css"/>
    <script type="text/javascript" src="classes/Brain.js"></script>
    <script type="text/javascript" src="classes/nBrains.js"></script>
    <script type="text/javascript" src="js/webgl.js" defer></script>
    <script type="text/javascript" src="js/utils.js" defer></script>
    <script type="text/javascript" src="js/gl-matrix-min.js" defer></script>
    <script type="text/javascript" src="js/point-functions.js"></script>
    <script type="text/javascript" src="js/networking.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.1/socket.io.min.js" integrity="sha512-/WwtKR6NnHomLo0O4w9QKc1INTPEJs7ko6u2aBTA1paPldhPl8LtXsi7a35iEZ69+9P5dcgVNESG8hrP4Y2t3w==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcijs@1.8.0/dist/bci.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">

    <title>Brainstorm</title>
</head>
<body onload="initialize()" style="overflow: hidden">
<!--<body style="overflow: hidden">-->
<noscript>
    <strong>We're sorry but Mousai Neurotechnologies doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
</noscript>

<div id=app>

    <!--Navbar-->
    <div id="app-menu">
        <div id="menu-toggle" class="toggle"><div class="icon"><i class="fas fa-angle-right fa-3x"></i></div></div>
        <div class="icon menuicon"><a href="https://brainsatplay.com" class="logo"><h3>Brains@Play</h3></a></div>
        </a>
        <div class="icon menuicon" onclick="state = 1">
            <a><i class="fas fa-brain fa-2x"></i></a><p>Main UI</p>
        </div>
        <div class="icon menuicon" onclick="state = 2">
            <a><i class="fas fa-wave-square fa-2x"></i></a><p>Inspect Voltages</p>
        </div>
        <!-- <div class="icon menuicon" onclick="openTutorial()">
            <a><i class="fas fa-book-open fa-2x"></i></a><p>Tutorial</p>
        </div> -->

        <!-- <a href="./app/brainstorm" download="proposed_file_name"> -->
            <div class="icon menuicon" onclick="window.open(`/downloadapp`)"">
            <a><i class="fas fa-desktop fa-2x"></i></a><p>Download Desktop App</p>
        </div>
    <!-- </a> -->
        <div class="user-info">
            <h4>Your Info</h4>
            <p id=userId></p>
        </div>
    </div>

    <!-- Chat Bar-->
    <div id="chat">
        <div id="chat-toggle" class="toggle"><div class="icon"><i class="fas fa-paper-plane fa-2x"></i></div></div>
        <ul id="messages"></ul>
        <form action="">
            <!--            <div class="gorm-group">-->
            <!--                <label for="user">User:</label>-->
            <!--                <input type="text" v-model="user" class="form-control">-->
            <!--            </div>-->
            <label for="message"></label>
            <input type="text" id="message" autocomplete="off" placeholder="Type message here..."/>
            <!--        <button id="chat-button" onclick="generateSignal()">-->
            <!--            <i class="fas fa-paper-plane fa-2x"></i>-->
            <!--            Send-->
            <!--        </button>-->
        </form>
    </div>

<div id="brainstorm">
<div id="canvas-container">
    <canvas id='webgl'></canvas>
</div>
<div id="tutorial">
    <div id="tutorial-text">
        <i class="fas fa-brain fa-3x"></i>
        <h1>Welcome to Brainstorm!</h1>
        <div class="tut-div">
            <p>Experience a social neurotechnology platform that enables you to manage your brain data and couple with other minds across social, cultural, and political boundaries.</p>
        </div>
        <div id="'tut-buttons">
            <button id="close-tutorial" onclick="closeTutorial()">
                <i class="fas fa-book fa-2x"></i>
                Close Tutorial
            </button>
        </div>
    </div>
</div>
<div id="parameters">
    <div id="param-toggle" class="toggle"><div class="icon"><i class="fas fa-magic fa-2x"></i></div></div>
    <div >
        <div>
            <button onclick="sendSignal(channels)">
                <i class="fas fa-wave-square fa-2x"></i>
                <p>Send Signal</p>
            </button>
        </div>
        <div>
            <button id="auto-generate" onclick=" generate = generateSignal(generate,channels)">
                <i class="fas fa-play-circle fa-2x"></i>
                <p>Autoplay Signal</p>
            </button>
        </div>
        <div class="flex wrap bound center">
            <p class="bound">Frequency: <span data-tw-bind="frequency">10</span></p>
            <input data-tw-bind="frequency" value = '10' type="range" min="1" max="100" class="slider" id="freqRange">
            <p class="bound">Channels</p>
            <select name="channels" id="channels">
                <option value="1">One</option>
                <option value="8">Eight</option>
                <option value="16">Sixteen</option>
            </select>
        </div>
        <div id="synchrony-div">
            <p>Synchrony</p>
            <div><span id = 'sync-dot' class="dot"></span></div>
        </div>
    </div>
</div>
    <div class="message-container">
        <span id="canvas-message"></span>
    </div>
<!--    <div id="visualization-options">-->
<!--        <button onclick="state=0;">-->
<!--            Brainstorm UI-->
<!--        </button>-->
<!--        <button onclick="state=1;">-->
<!--            Data Stream-->
<!--        </button>-->
<!--    </div>-->
</div>
</div>

<script>


    // WebGL Setup
    let canvas = document.getElementById('webgl');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let gl = canvas.getContext('webgl')
    // shape_array = ['brain', 'voltage', shapes.sphereShell, shapes.sphereShell2, shapes.boxShell, shapes.circularHyperboloid]
    // render_array = [gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS, gl.POINTS]
    let shape_array = [['sphereShells','brains'], ['brain'], ['voltage'],['brains']]
    let anim_array = [[5.0,3.0],[false],[false],[false]] // In seconds; false has no animation
    let render_array = [[gl.POINTS, gl.POINTS],[gl.POINTS], [gl.LINES],[gl.POINTS]];
    let message_array = [['scanning your brain...', 'welcome to the brainstorm'], [''], [''], ['']];
    let ease_array = [[.1, .1],[.1], [.1], [.1]];

    let state = 0;
    let prevState = 0;
    let animState = 0;
    let animStart = Date.now();

    // WebGL Containers
    let brainVertices;
    let brainMesh;
    let vertexHome;
    let vertexCurr;
    let vertexVel;

    let viewMatrix;

    let positionBuffer;
    let dispBuffer;

    // WebGL Variables
    let DESIRED_POINTS = 1e5/2; // 80000
    let SIGNAL_SUSTAIN = 150;
    let signal_sustain;
    let pointCount;
    let INITIAL_Z_OFFSET = 1.7;
    let VOLTAGE_Z_OFFSET = 1.7;
    let AUTO_ROTATION_X = 0.0; //0.2;
    let INNER_Z = 2*VOLTAGE_Z_OFFSET;

    let displacement = [];
    let disp_flat = [];
    SYNCHRONY_BUFFER_SIZE = 100;
    let synchrony = new Array(SYNCHRONY_BUFFER_SIZE).fill(0);

    // Camera
    let cameraHome = INITIAL_Z_OFFSET;
    let cameraCurr = INITIAL_Z_OFFSET;

    // Point Movement
    let DAMPING = .1;
    let epsilon = .001;
    let t = 0.0;
    let diff_x = 0;
    let diff_y = 0;

    let ease = true;
    let rotation = true;
    let zoom = true;

    // Signal Generation Variables
    let channels = 1;
    let generate = false;
    let samplerate = 125; // This is almost definitely wrong
    let generate_interval; // updated when generate is true
    let count = 0;

    // Distortion Variables
    let distort = false;
    let distortion = 0;
    let distortFlag = false;
    let distortIter = 1;

    // WebSocket Setup
    let messages = []
    let option = 'local';
    let url;
    if (option  === 'local'){
        url = new URL('http://localhost');
    } else if (option === 'server'){
        url = new URL('https://brainsatplay.azurewebsites.net/');
    }

    let brains;
    let userId = undefined;
    let ws;

    $(function () {
        $('form').submit(function(e) {
            e.preventDefault(); // prevents page reloading
            if (!ws) {
                showMessage('No WebSocket connection');
                return;
            }
            ws.send(JSON.stringify({'destination':'chat',
                'msg': $('#message').val()
            })
                );
            $('#message').val('');
            return false;
        });
    });

    // Begin the Brainstorm
    setCookie('connectionType','interface', 30)
    clientAction('login','POST');

    $('#canvas-message').animate({'opacity': 0}, 400, function(){
        $(this).html('loading...').animate({'opacity': 1}, 400);
    });


    // Check SIGNAL_SUSTAIN is odd
    if (SIGNAL_SUSTAIN%2 == 0){
            SIGNAL_SUSTAIN += 1;
    }

    function initialize() {

        createPointCloud('brain').then((cloud) => { 
                brainVertices = reducePointCount(cloud, DESIRED_POINTS);
                pointCount = brainVertices.length / 3;
                establishWebsocketConnection();
                brains = newBrains(userId);
                particleBrain()
        }
        )
    }

</script>

</body>
</html>
